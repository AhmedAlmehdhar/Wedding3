<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>كروت حفل زفاف</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f7f7f7;
    }
    h1 { text-align: center; margin-bottom: 15px; font-size: 1.5em; }
    form {
      max-width: 400px;
      margin: 0 auto 20px auto;
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 0.9em; }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
    }
    #myButton { background-color: #4CAF50; color: #fff; }
    #myButton:hover:enabled { background-color: #45a049; }
    #myButton:disabled { background-color: #9ccc9c; cursor: not-allowed; }

    #image-preview { max-width:100%; margin-top:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; word-break: break-word; }
    th { background:#4CAF50; color:white; }
    .delete-button, .whatsapp-button { padding:5px 8px; border:none; border-radius:4px; cursor:pointer; font-size:0.8em; }
    .delete-button { background:#dc3545; color:white; }
    .delete-button:hover { background:#c82333; }
    .whatsapp-button { background:#25D366; color:white; margin-top:3px; }
    .whatsapp-button:hover { background:#128C7E; }

    /* Notification CSS */
    .notification {
      position: fixed;
      top: -80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 1em;
      font-weight: bold;
      z-index: 10000;
      transition: top 0.5s ease, opacity 0.5s ease;
      opacity: 0;
    }
    .notification.show { top: 20px; opacity: 1; }
    .notification.error { background-color: #dc3545; }

    /* Modern uploading animation */
    .uploading-animation {
      display: none;
      text-align: center;
      margin-top: 15px;
    }
    .uploading-animation span {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin: 0 5px;
      background: #4CAF50;
      border-radius: 50%;
      animation: bounce 0.6s infinite alternate;
    }
    .uploading-animation span:nth-child(2) { animation-delay: 0.2s; }
    .uploading-animation span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { to { transform: translateY(-15px); opacity: 0.6; } }

    @media (max-width: 500px) {
      h1 { font-size: 1.2em; }
      form { padding: 10px; }
      input, button { font-size: 0.9em; padding:8px; }
      th, td { font-size:0.8em; padding:6px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/neocotic/qrious/dist/qrious.min.js"></script>
</head>
<body>
  <h1>موقع كروت الأفراح</h1>

  <!-- Notification container -->
  <div id="notification" class="notification"></div>

  <form id="my-form">
    <label for="text-input">أدخل اسم الضيف:</label>
    <input type="text" id="text-input" placeholder="مثال: أحمد">
    <button type="button" id="myButton">إطبع الكرت</button>
    <div id="uploading-animation" class="uploading-animation">
      <span></span><span></span><span></span>
    </div>
  </form>

  <img id="image-preview" src="3.jpg" alt="Image Preview">

  <h2>عدد الضيوف الحالي: <span id="nodeCount">0</span></h2>
  <div id="output"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, set, push, get, onValue, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ",
      authDomain: "final-draft-8f39d.firebaseapp.com",
      databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com",
      projectId: "final-draft-8f39d",
      storageBucket: "final-draft-8f39d.appspot.com",
      messagingSenderId: "994437210054",
      appId: "1:994437210054:web:628c741b81ccf741175cc7"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const guestNameInput = document.getElementById("text-input");
    const insertBtn = document.getElementById("myButton");
    const uploadingAnim = document.getElementById("uploading-animation");
    let randomFourDigitNumber;

    function showNotification(message, type="success") {
      const notif = document.getElementById("notification");
      notif.textContent = message;
      notif.className = `notification show ${type}`;
      setTimeout(() => { notif.className = "notification"; }, 3000);
    }

    insertBtn.addEventListener("click", async () => {
      const guestNameValue = guestNameInput.value.trim();
      if (!guestNameValue) { showNotification("من فضلك أدخل اسم صحيح", "error"); return; }

      randomFourDigitNumber = Math.floor(1000 + Math.random() * 9000).toString();
      const dataToInsert = { الإسم: guestNameValue, رقم_عشوائي: randomFourDigitNumber };
      const newKey = push(ref(database), dataToInsert).key;

      // Show uploading animation and disable button
      insertBtn.disabled = true;
      uploadingAnim.style.display = "block";

      try {
        await set(ref(database, newKey), dataToInsert);
        const cardURL = await uploadCardToBBImg();
        await set(ref(database, `${newKey}/link`), cardURL);
        showNotification("تمت إضافة الضيف بنجاح", "success");
        readData();
        updateNodeCount();
        guestNameInput.value = "";
      } catch(e) {
        showNotification(e.message, "error");
      } finally {
        insertBtn.disabled = false;
        uploadingAnim.style.display = "none";
      }
    });

    async function uploadCardToBBImg() {
      const image = document.getElementById("image-preview");
      const canvas = document.createElement("canvas");
      canvas.width = image.naturalWidth;
      canvas.height = image.naturalHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(image, 0, 0);
      ctx.font = "40px Arial"; ctx.fillStyle = "red"; ctx.textAlign = "center";
      ctx.fillText(randomFourDigitNumber, canvas.width/2, canvas.height/2 - 40);
      ctx.fillText(guestNameInput.value, canvas.width/2, canvas.height/2 + 40);
      const qr = new QRious({ value: randomFourDigitNumber, size: 126, background:'transparent' });
      ctx.drawImage(qr.canvas, canvas.width/2 - 64, canvas.height - 128);

      const base64Image = canvas.toDataURL().split(',')[1];
      const formData = new FormData();
      formData.append('image', base64Image);
      const apiKey = '97c60166127ae9258012f463e09b1e2d';
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
      const data = await response.json();
      return data.data.url;
    }

    function readData() {
      onValue(ref(database), (snapshot) => {
        const data = snapshot.val();
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = "";
        if (!data) return;

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        ["رقم الكرت", "الإسم", "رابط الكرت", "حذف", "واتساب"].forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        Object.entries(data).forEach(([key, val], index) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${index+1}</td><td>${val.الإسم}</td><td><a href='${val.link || "#"}' target='_blank'>عرض</a></td>`;

          const delBtn = document.createElement("button");
          delBtn.textContent = "حذف";
          delBtn.className = "delete-button";
          delBtn.onclick = () => remove(ref(database, key));
          const tdDel = document.createElement("td"); tdDel.appendChild(delBtn);
          row.appendChild(tdDel);

          const whatsappBtn = document.createElement("button");
          whatsappBtn.textContent = "واتساب";
          whatsappBtn.className = "whatsapp-button";
          whatsappBtn.onclick = () => { if(val.link) window.open(`https://wa.me/?text=${encodeURIComponent('كرت الدعوة: '+val.link)}`,'_blank'); };
          const tdWhats = document.createElement("td"); tdWhats.appendChild(whatsappBtn);
          row.appendChild(tdWhats);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        outputDiv.appendChild(table);
      });
    }

    async function updateNodeCount() {
      const snapshot = await get(ref(database));
      document.getElementById('nodeCount').textContent = snapshot.size || 0;
    }

    window.onload = () => {
      readData();
      updateNodeCount();
    };
  </script>
</body>
</html>
